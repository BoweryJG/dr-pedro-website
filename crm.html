<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard | Dr. Pedro</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: var(--primary-light, #e6f0fa); }
        .crm-container {
            max-width: 700px;
            margin: 48px auto;
            background: var(--bg, #fff);
            border-radius: 32px;
            box-shadow: 0 8px 32px #3ed6c120, 0 2px 12px #ffe9b055;
            padding: 32px 24px 24px 24px;
        }
        .crm-header { font-size: 2.2rem; font-weight: 700; color: var(--primary, #3ed6c1); margin-bottom: 18px; }
        .crm-form input, .crm-form textarea {
            width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 12px; border: 1.5px solid #e6f0fa; background: #fafdff;
        }
        .crm-form button { background: var(--primary, #3ed6c1); color: #fff; border: none; border-radius: 12px; padding: 10px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .crm-form button:hover { background: var(--accent, #ffe9b0); color: #23272b; }
        .crm-table { width: 100%; border-collapse: collapse; margin-top: 22px; }
        .crm-table th, .crm-table td { padding: 10px; border-bottom: 1px solid #e6f0fa; text-align: left; }
        .crm-table th { background: var(--primary-light, #e6f0fa); color: var(--primary, #3ed6c1); }
        .crm-actions button { margin-right: 6px; border-radius: 8px; border: none; padding: 6px 12px; font-size: 0.95rem; cursor: pointer; }
        .crm-actions .edit-btn { background: #ffe9b0; color: #23272b; }
        .crm-actions .delete-btn { background: #ffb0b0; color: #23272b; }
        .crm-actions .edit-btn:hover { background: #fff2d6; }
        .crm-actions .delete-btn:hover { background: #ffd6d6; }
        .crm-login {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 70vh;
        }
        .crm-login input { padding: 10px; border-radius: 10px; border: 1.5px solid #e6f0fa; margin-bottom: 14px; }
        .crm-login button { background: var(--primary, #3ed6c1); color: #fff; border: none; border-radius: 10px; padding: 10px 18px; font-weight: 600; cursor: pointer; }
        .crm-login button:hover { background: var(--accent, #ffe9b0); color: #23272b; }
    </style>
</head>
<body>
    <div id="crm-login" class="crm-login">
        <h2>Staff Login</h2>
        <input type="password" id="crm-password" placeholder="Enter admin password" autocomplete="off" />
        <button onclick="crmLogin()">Login</button>
        <div id="crm-login-msg" style="color: #e74c3c; margin-top: 8px;"></div>
    </div>
    <div id="crm-app" style="display:none;">
        <div class="crm-container">
            <div class="crm-header">CRM Dashboard</div>
            <div class="crm-dashboard" style="margin-bottom:32px;display:flex;gap:32px;align-items:center;flex-wrap:wrap;">
                <div style="flex:1;min-width:180px;background:#fafdff;border-radius:18px;padding:18px 20px 14px 20px;box-shadow:0 2px 12px #e6f0fa;">
                    <div style="font-size:1.2rem;color:#5f6c7b;">Total Patients</div>
                    <div id="crm-total" style="font-size:2.1rem;font-weight:700;color:#3ed6c1;">0</div>
                </div>
                <div style="flex:1;min-width:180px;background:#fafdff;border-radius:18px;padding:18px 20px 14px 20px;box-shadow:0 2px 12px #e6f0fa;">
                    <div style="font-size:1.2rem;color:#5f6c7b;">Added This Month</div>
                    <div id="crm-month" style="font-size:2.1rem;font-weight:700;color:#3ed6c1;">0</div>
                </div>
                <div style="flex:2;min-width:220px;background:#fafdff;border-radius:18px;padding:18px 20px 14px 20px;box-shadow:0 2px 12px #e6f0fa;">
                    <div style="font-size:1.2rem;color:#5f6c7b;">Patients by Month</div>
                    <div id="crm-chart" style="display:flex;align-items:flex-end;height:60px;gap:8px;margin-top:10px;"></div>
                </div>
            </div>
            <form id="crm-form" class="crm-form">
                <input type="hidden" id="crm-id">
                <input type="text" id="crm-name" placeholder="Patient Name" required>
                <input type="email" id="crm-email" placeholder="Email" required>
                <input type="tel" id="crm-phone" placeholder="Phone" required>
                <textarea id="crm-notes" placeholder="Notes"></textarea>
                <button type="submit">Add / Update Patient</button>
            </form>
            <table class="crm-table" id="crm-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Notes</th>
                        <th>Date Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        // Simple password (change this in production!)
        const CRM_PASSWORD = "drpedro2024";
        function crmLogin() {
            const pw = document.getElementById('crm-password').value;
            if (pw === CRM_PASSWORD) {
                document.getElementById('crm-login').style.display = 'none';
                document.getElementById('crm-app').style.display = '';
            } else {
                document.getElementById('crm-login-msg').textContent = 'Incorrect password.';
            }
        }

        // CRUD logic using localStorage
        function getPatients() {
            return JSON.parse(localStorage.getItem('crmPatients') || '[]');
        }
        function savePatients(patients) {
            localStorage.setItem('crmPatients', JSON.stringify(patients));
        }
        function renderDashboard() {
            const patients = getPatients();
            // Total patients
            document.getElementById('crm-total').textContent = patients.length;
            // Added this month
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            let monthCount = 0;
            let monthMap = {};
            patients.forEach(p => {
                let d = p.date;
                let dt = d ? new Date(d) : null;
                // Try to parse MM/DD/YYYY or YYYY-MM-DD
                if (!dt || isNaN(dt)) {
                    let parts = d && d.includes('/') ? d.split('/') : d ? d.split('-') : [];
                    if (parts.length === 3) {
                        if (parts[0].length === 4) dt = new Date(parts[0], parts[1] - 1, parts[2]);
                        else dt = new Date(parts[2], parts[0] - 1, parts[1]);
                    }
                }
                if (dt && dt.getMonth() === thisMonth && dt.getFullYear() === thisYear) monthCount++;
                // Build monthly summary
                if (dt) {
                    const key = `${dt.getFullYear()}-${dt.getMonth()+1}`;
                    monthMap[key] = (monthMap[key] || 0) + 1;
                }
            });
            document.getElementById('crm-month').textContent = monthCount;
            // Render mini bar chart
            const chart = document.getElementById('crm-chart');
            chart.innerHTML = '';
            // Show last 6 months
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(thisYear, thisMonth - i, 1);
                const key = `${d.getFullYear()}-${d.getMonth()+1}`;
                months.push({
                    label: d.toLocaleString('default', { month: 'short' }),
                    count: monthMap[key] || 0
                });
            }
            const max = Math.max(1, ...months.map(m => m.count));
            months.forEach(m => {
                const bar = document.createElement('div');
                bar.style.height = (m.count ? (m.count / max * 48 + 8) : 8) + 'px';
                bar.style.width = '22px';
                bar.style.background = m.count ? 'linear-gradient(180deg,#3ed6c1,#ffe9b0)' : '#e6f0fa';
                bar.style.borderRadius = '8px 8px 0 0';
                bar.style.display = 'flex';
                bar.style.alignItems = 'flex-end';
                bar.style.justifyContent = 'center';
                bar.style.marginRight = '3px';
                bar.title = m.label + ': ' + m.count;
                bar.innerHTML = `<span style='font-size:0.8em;color:#5f6c7b;position:absolute;transform:translateY(-18px);'>${m.count||''}</span>`;
                const label = document.createElement('div');
                label.textContent = m.label;
                label.style.fontSize = '0.85em';
                label.style.color = '#5f6c7b';
                label.style.marginTop = '4px';
                label.style.textAlign = 'center';
                chart.appendChild(bar);
                chart.appendChild(label);
            });
            // If no data, show sample
            if (patients.length === 0) {
                document.getElementById('crm-total').textContent = '3';
                document.getElementById('crm-month').textContent = '1';
                chart.innerHTML = '';
                [2,1,3,0,0,1].forEach((c,i) => {
                    const bar = document.createElement('div');
                    bar.style.height = (c ? (c / 3 * 48 + 8) : 8) + 'px';
                    bar.style.width = '22px';
                    bar.style.background = c ? 'linear-gradient(180deg,#3ed6c1,#ffe9b0)' : '#e6f0fa';
                    bar.style.borderRadius = '8px 8px 0 0';
                    bar.style.display = 'flex';
                    bar.style.alignItems = 'flex-end';
                    bar.style.justifyContent = 'center';
                    bar.style.marginRight = '3px';
                    bar.title = `${['Nov','Dec','Jan','Feb','Mar','Apr'][i]}: ${c}`;
                    bar.innerHTML = `<span style='font-size:0.8em;color:#5f6c7b;position:absolute;transform:translateY(-18px);'>${c||''}</span>`;
                    const label = document.createElement('div');
                    label.textContent = ['Nov','Dec','Jan','Feb','Mar','Apr'][i];
                    label.style.fontSize = '0.85em';
                    label.style.color = '#5f6c7b';
                    label.style.marginTop = '4px';
                    label.style.textAlign = 'center';
                    chart.appendChild(bar);
                    chart.appendChild(label);
                });
            }
        }
        function renderTable() {
            const tbody = document.querySelector('#crm-table tbody');
            tbody.innerHTML = '';
            getPatients().forEach((p, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${p.name}</td><td>${p.email}</td><td>${p.phone}</td><td>${p.notes||''}</td><td>${p.date}</td><td class='crm-actions'><button class='edit-btn' onclick='editPatient(${idx})'>Edit</button><button class='delete-btn' onclick='deletePatient(${idx})'>Delete</button></td>`;
                tbody.appendChild(tr);
            });
            renderDashboard();
        }
        document.getElementById('crm-form').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('crm-id').value;
            const name = document.getElementById('crm-name').value.trim();
            const email = document.getElementById('crm-email').value.trim();
            const phone = document.getElementById('crm-phone').value.trim();
            const notes = document.getElementById('crm-notes').value.trim();
            let patients = getPatients();
            if (id) {
                patients[id] = { ...patients[id], name, email, phone, notes };
            } else {
                patients.push({ name, email, phone, notes, date: new Date().toLocaleDateString() });
            }
            savePatients(patients);
            this.reset();
            document.getElementById('crm-id').value = '';
            renderTable();
        };
        window.editPatient = function(idx) {
            const p = getPatients()[idx];
            document.getElementById('crm-id').value = idx;
            document.getElementById('crm-name').value = p.name;
            document.getElementById('crm-email').value = p.email;
            document.getElementById('crm-phone').value = p.phone;
            document.getElementById('crm-notes').value = p.notes;
        };
        window.deletePatient = function(idx) {
            let patients = getPatients();
            if (confirm('Delete this patient?')) {
                patients.splice(idx, 1);
                savePatients(patients);
                renderTable();
            }
        };
        // Render table on login
        if (document.getElementById('crm-app').style.display !== 'none') renderTable();
    </script>
</body>
</html>
